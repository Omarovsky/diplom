<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–õ–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è</title>
    <style>
        :root {
            --bg-primary: #2b2d31;
            --bg-secondary: #313338;
            --bg-tertiary: #1e1f22;
            --accent: #5865f2;
            --hover: #404249;
            --text-main: #f2f3f5;
            --text-muted: #b5bac1;
            --border-color: #1a1b1e;
        }

        * {
            box-sizing: border-box;
        }

        body {
            display: flex;
            height: 100vh;
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-main);
        }

        #sidebar {
            width: 260px;
            background-color: var(--bg-secondary);
            padding: 15px;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border-color);
        }

        #sidebar h3 {
            margin-top: 10px;
            margin-bottom: 5px;
            font-size: 14px;
            color: var(--text-muted);
        }

        #sidebar input,
        #sidebar button {
            background-color: var(--bg-tertiary);
            color: var(--text-main);
            border: none;
            border-radius: 6px;
            padding: 8px;
            margin-top: 5px;
            font-size: 13px;
        }

        #sidebar input::placeholder {
            color: var(--text-muted);
        }

        #sidebar button {
            background-color: var(--accent);
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        #sidebar button:hover {
            background-color: #4752c4;
        }

        #dialogList button {
            width: 100%;
            text-align: left;
            padding: 8px;
            margin-top: 5px;
            border-radius: 6px;
            background-color: var(--bg-tertiary);
            color: var(--text-main);
            font-size: 13px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        #dialogList button:hover {
            background-color: var(--hover);
        }

        #main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: var(--bg-primary);
        }

        #chat {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        #chat div {
            background-color: var(--bg-secondary);
            padding: 10px 14px;
            border-radius: 8px;
            max-width: 75%;
            font-size: 14px;
            line-height: 1.4;
        }

        #inputBar {
            display: flex;
            padding: 14px;
            border-top: 1px solid var(--border-color);
            background-color: var(--bg-secondary);
            gap: 10px;
        }

        #messageInput {
            flex: 1;
            background-color: var(--bg-tertiary);
            color: var(--text-main);
            border: none;
            border-radius: 8px;
            padding: 10px;
            font-size: 14px;
        }

        #messageInput::placeholder {
            color: var(--text-muted);
        }

        button {
            background-color: var(--accent);
            color: white;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            padding: 10px 14px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        button:hover {
            background-color: #4752c4;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }

        ::-webkit-scrollbar-thumb {
            background-color: #4e5058;
            border-radius: 4px;
        }

        .status {
            text-align: center;
            margin: 12px 0 16px 0;
            color: #ffffff;
        }
    </style>

</head>
<body>
    <div id="sidebar">
        <h3>–¢–æ–∫–µ–Ω</h3>
        <input type="text" id="token" placeholder="JWT —Ç–æ–∫–µ–Ω" style="width: 100%;"><br>
        <button onclick="fetchDialogs()">–í–≤–µ—Å—Ç–∏ —Ç–æ–∫–µ–Ω</button><br><br>

        <h3>–ù–æ–≤—ã–π –¥–∏–∞–ª–æ–≥</h3>
        <input type="number" id="newUserId" placeholder="ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" style="width: 100%;">
        <button onclick="createDialog()">–°–æ–∑–¥–∞—Ç—å</button><br><br>

        <h3>–î–∏–∞–ª–æ–≥–∏</h3>
        <div id="dialogList"></div>
    </div>

    <div id="main">
        <div id="chat"></div>
        <div id="inputBar">
            <input type="text" id="messageInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." style="flex: 1;">
            <button onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
    </div>

    <div style="margin-bottom: 1em;">
    <video id="localVideo" autoplay muted playsinline style="width: 200px; border: 1px solid #ccc;"></video>
    <video id="remoteVideo" autoplay playsinline style="width: 200px; border: 1px solid #ccc;"></video>
</div>
<div>
    <button onclick="startCall()">–í–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫</button>
    <button onclick="startScreenShare()">–ü–æ–∫–∞–∑–∞—Ç—å —ç–∫—Ä–∞–Ω</button>
    <button onclick="hangUp()">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
    <div class="status" id="status"></div>
</div>
    <script>
        let socket = null;
        let currentDialogId = null;
        let localStream = null;
        let remoteStream = null;
        let pc = null;
        let ws = null;
        let token = "";

        async function fetchDialogs() {
            token = document.getElementById("token").value.trim();
            const res = await fetch("http://localhost:8000/direct/dialogs", {
                headers: { "Authorization": "Bearer " + token }
            });
            const dialogs = await res.json();
            const list = document.getElementById("dialogList");
            list.innerHTML = "";
            dialogs.forEach(dialog => {
                const btn = document.createElement("button");
                btn.textContent = "–î–∏–∞–ª–æ–≥ #" + dialog.id;
                btn.onclick = () => connectToDialog(dialog.id);
                list.appendChild(btn);
            });
        }

        async function createDialog() {
            const token = document.getElementById("token").value.trim();
            const userId = document.getElementById("newUserId").value;
            if (!userId) return;

            const res = await fetch(`http://localhost:8000/direct/dialog/${userId}`, {
                method: "POST",
                headers: { "Authorization": "Bearer " + token }
            });

            const data = await res.text();
            console.log("Response:", res.status, data);

            if (res.ok) {
                await fetchDialogs();
            } else {
                alert("‚ùå –û—à–∏–±–∫–∞: " + res.status + " ‚Äî " + data);
            }
        }

        async function connectToDialog(dialogId) {
            const token = document.getElementById("token").value.trim();
            currentDialogId = dialogId;

            if (socket) socket.close();

            socket = new WebSocket(`ws://localhost:8000/ws-direct/${dialogId}?token=${token}`);
            socket.onmessage = e => {
                const msg = JSON.parse(e.data);
                console.log(msg);
                if(msg.allmessages) {
                    msg.allmessages.forEach(m => {
                        addMessage(`[${m.sender_id}] ${m.full_name}: ${m.content}`);
                    });
                }
                else addMessage(`[${msg.sender_id}] ${msg.full_name}: ${msg.content}`);
            };
            socket.onopen = () => {
                document.getElementById("chat").innerHTML = "";
                addMessage("üü¢ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ –¥–∏–∞–ª–æ–≥—É #" + dialogId);
            };
        }

        function sendMessage() {
            const input = document.getElementById("messageInput");
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({ content: input.value }));
                input.value = "";
            }
        }

        function addMessage(text) {
            console.log("addMessage called with:", text);
            const p = document.createElement("div");
            p.innerHTML = text;
            document.getElementById("chat").appendChild(p);
            document.getElementById("chat").scrollTop = document.getElementById("chat").scrollHeight;
        }


        document.getElementById("messageInput").addEventListener("keydown", function (e) {
            if (e.key === "Enter") {
                e.preventDefault();
                sendMessage();
            }
        });

        function setStatus(msg) {
            document.getElementById('status').textContent = msg;
        }

        function startCall() {
            if (pc || ws) {
                setStatus('–ó–≤–æ–Ω–æ–∫ —É–∂–µ –∞–∫—Ç–∏–≤–µ–Ω. –ó–∞–≤–µ—Ä—à–∏—Ç–µ —Ç–µ–∫—É—â–∏–π!');
                return;
            }

            ws = new WebSocket(`ws://127.0.0.1:8000/ws-webrtc/${currentDialogId}?token=${token}`);

            ws.onopen = () => setStatus('–°–∏–≥–Ω–∞–ª—å–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ. –û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞...');
            ws.onerror = () => setStatus('–û—à–∏–±–∫–∞ WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
            ws.onclose = () => cleanup();

            ws.onmessage = async (event) => {
                const msg = JSON.parse(event.data);
                if (msg.type === "offer") {
                    await pc.setRemoteDescription(new RTCSessionDescription(msg.offer));
                    const answer = await pc.createAnswer();
                    await pc.setLocalDescription(answer);
                    ws.send(JSON.stringify({ type: "answer", answer }));
                    setStatus('–ü–æ–ª—É—á–µ–Ω–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ. –û—Ç–ø—Ä–∞–≤–ª–µ–Ω –æ—Ç–≤–µ—Ç.');
                } else if (msg.type === "answer") {
                    await pc.setRemoteDescription(new RTCSessionDescription(msg.answer));
                    setStatus('–°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –ø—Ä–∏–Ω—è–ª –∑–≤–æ–Ω–æ–∫!');
                } else if (msg.type === "ice") {
                    await pc.addIceCandidate(msg.candidate);
                }
            };

            pc = new RTCPeerConnection({
                iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
            });

            pc.onicecandidate = (event) => {
                if (event.candidate) {
                    ws.send(JSON.stringify({ type: "ice", candidate: event.candidate }));
                }
            };

            pc.ontrack = (event) => {
                document.getElementById('remoteVideo').srcObject = event.streams[0];
            };

            navigator.mediaDevices.getUserMedia({ video: true, audio: true })
                .then(stream => {
                    localStream = stream;
                    document.getElementById('localVideo').srcObject = stream;
                    stream.getTracks().forEach(track => pc.addTrack(track, stream));
                    return pc.createOffer();
                })
                .then(offer => {
                    pc.setLocalDescription(offer);
                    ws.send(JSON.stringify({ type: "offer", offer }));
                    setStatus('–ó–≤–æ–Ω–æ–∫ –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–Ω. –û–∂–∏–¥–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞...');
                })
                .catch(err => {
                    setStatus("–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ/–º–∏–∫—Ä–æ—Ñ–æ–Ω—É: " + err.message);
                    cleanup();
                });
        }

        function startScreenShare() {
            if (!pc) {
                setStatus('–°–Ω–∞—á–∞–ª–∞ –Ω–∞—á–Ω–∏—Ç–µ –∑–≤–æ–Ω–æ–∫!');
                return;
            }
            navigator.mediaDevices.getDisplayMedia({ video: true })
                .then(screenStream => {
                    document.getElementById('localVideo').srcObject = screenStream;
                    const videoTrack = screenStream.getVideoTracks()[0];
                    const sender = pc.getSenders().find(s => s.track && s.track.kind === 'video');
                    if (sender) sender.replaceTrack(videoTrack);
                    setStatus('–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —ç–∫—Ä–∞–Ω–∞ –Ω–∞—á–∞–ª–∞—Å—å');
                    videoTrack.onended = () => {
                        if (localStream) {
                            document.getElementById('localVideo').srcObject = localStream;
                            const camTrack = localStream.getVideoTracks()[0];
                            if (camTrack && sender) sender.replaceTrack(camTrack);
                            setStatus('–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —ç–∫—Ä–∞–Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
                        }
                    };
                })
                .catch(err => setStatus("–û—à–∏–±–∫–∞ –∑–∞—Ö–≤–∞—Ç–∞ —ç–∫—Ä–∞–Ω–∞: " + err.message));
        }

        function hangUp() {
            if (ws) {
                ws.close();
                ws = null;
            }
            cleanup();
            setStatus('–ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à—ë–Ω');
        }

        function cleanup() {
            if (pc) {
                pc.close();
                pc = null;
            }
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            document.getElementById('localVideo').srcObject = null;
            document.getElementById('remoteVideo').srcObject = null;
            setStatus('–ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à—ë–Ω');
        }

    </script>
</body>
</html>